-- Neeps: easy questions

-- 1.Give the room id in which the event co42010.L01 takes place.

select room
from event
where id='co42010.L01'

-- Result:
room
cr.132

-- 2.For each event in module co72010 show the day, the time and the place.

select dow, tod, room
from event
where modle='co72010'

-- Result:
dow	tod	room
Wednesday	14:00	cr.SMH
Tuesday	09:00	cr.B8
Wednesday	09:00	co.B7
Tuesday	12:00	co.LB42+LB46
Tuesday	11:00	co.G75+G76
Wednesday	16:00	co.LB42+LB46
Thursday	10:00	co.LB42+LB46
Wednesday	13:00	co.117+118

-- 3.List the names of the staff who teach on module co72010.

select distinct(name)
from staff
join teaches on staff.id=teaches.staff
join event on teaches.event=event.id
where modle='co72010'

-- Result:
name
Cumming, Andrew
Chisholm, Ken

--4.Give a list of the staff and module number associated with events using room cr.132 on Wednesday, include the time each event starts.

select name, modle, tod
from staff
join teaches on staff.id=teaches.staff
join event on teaches.event=event.id
where room='cr.132' and dow='Wednesday'

-- Result:
name	modle	tod
Murray, Jim	co22009	12:00
Varey, Alison	co32021	09:00

-- 5.Give a list of the student groups which take modules with the word 'Database' in the name.

select student.id, student.name, event.modle, modle.name
from modle
join event on event.modle=modle.id
right join attends on attends.event=event.id
right join student on attends.student=student.id
where modle.name LIKE "%Database%"
group by student.id

-- Result:
id	name	modle	name
co4.CO	BSc4 Computing	co42009	Object Oriented Databases
co4.ND	BEng4 Network and Distributing Systems	co42009	Object Oriented Databases
com.IS	PgD Information Systems	co72010	Database systems
com.IS.a	PgD Information Systems a (HCI)	co72010	Database systems
com.IS.b	PgD Information Systems b (DS)	co72010	Database systems
com.IS.d	PgD Information Systems d (BT)	co72010	Database systems
com.IS.e	PgD Information Systems e (OOP)	co72010	Database systems
com.IS.tu	PgD Information System pt. Tues	co72010	Database systems
com.ITeC	PgD IT and e-Commerce	co72026	Very Large Databases
com.ITeC.feb		co72010	Database systems
com.ITeC.z3	PgD IT and e-Commerce eve sem 3	co72026	Very Large Databases
com.SE	PgD Software Engineering	co72010	Database systems
com.ST	PgD Software Technology	co72010	Database systems
com.ST.tu	PgD Software Technology pt. Tues	co72010	Database systems

-- Neeps: medium questions

-- 6.Show the 'size' of each of the co72010 events. Size is the total number of students attending each event.

select sum(sze)
from student

-- shows that there are total 2250 students

select *
from modle
where id='co72010'

-- final query

select modle, event, sum(sze)
from modle
join event on modle.id=event.modle
join attends on event.id=attends.event
join student on student.id=attends.student
where modle.id='co72010'
group by event

-- Result:
modle	event	sum(sze)
co72010	co72013.L01	215
co72010	co72013.L02	10
co72010	co72013.T01	40
co72010	co72013.T02	49
co72010	co72013.T03	10
co72010	co72013.T04	45
co72010	co72013.T05	35
co72010	co72013.T06	29

-- 7.For each post-graduate module, show the size of the teaching team. (post graduate modules start with the code co7).

select modle, count(distinct(staff))
from event
join teaches on teaches.event=event.id
where modle LIKE "co7%"
group by model

-- Result:
modle	count(distinc..
co72002	1
co72003	2
co72004	1
co72005	2
co72006	1
co72010	2
co72011	2
co72012	1
co72016	2
co72017	1
co72018	1
co72021	1
co72026	2
co72033	1

-- 8.Give the full name of those modules which include events taught for fewer than 10 weeks.

-- Query attempt 1
select distinct(modle.name)
from modle
join event on event.modle=modle.id
where event.id NOT IN (
select distinct(event)
from occurs
where week >= 10)

-- Result: WRONG because it is missing "Internet Multimedia" due to some oversight
name
Languages and Algorithms
Project
Interactivity and the Internet

-- Query attempt 2
select name
from modle
left join event on event.modle=modle.id
left join occurs on occurs.event=event.id
where modle.id NOT IN 
(
select modle.id
from modle
left join event on event.modle=modle.id
left join occurs on occurs.event=event.id
where week >=10
group by modle.id
)
and week is not NULL
group by modle.name

-- Result: WRONG because it is missing 3 module names now
name
Project

-- Query 3 attempt is to simply count the number of times an event id repeats in occurs to check for the number of weeks it ran for.
-- WORKED!

select distinct(modle.name)
from event
join
(
select event, count(event) C
from occurs
group by event
Having C <10
order by C
) Novo
on event.id=Novo.event
join modle on modle.id=event.modle

-- Result:
name
Languages and Algorithms
Project
Internet Multimedia
Interactivity and the Internet

-- 9.Identify those events which start at the same time as one of the co72010 lectures.

-- query attempt 1
select distinct(b.id)
from event a
join event b on a.tod=b.tod
where a.modle='co72010'

-- Result: WRONG and 170 in nos. issue is we only accounted for the tod and not the dow.
id
co12004.L01
co12004.T01
co12004.T03
co12004.T04
co12004.T05
co12004.T06

-- query attempt 2: No result!

select b.id
from event b
join
(
select modle, concat(dow,"-",tod)dowtod
from event a
) Novo
on b.concat(dow,"-",tod)=Novo.dowtod
where Novo.modle='co72010'

-- query attempt 3: Worked!

select event.id
from event
where concat(dow,"-",tod) IN
(select concat(dow,"-",tod)
from event
where modle='co72010')

-- Result: 42 events in count
id
co12004.T04
co12004.T05
co12005.T01
co12005.T04
co12006.L03
co12008.L01
co12012.T01
co22005.T02
co22005.T04
co22005.T07
co22005.T08
co22006.L02
co22008.T03
co22008.T04
co22009.T02
co32011.T03
co32014.T01
co32016.L01
co32018.L01
co32021.L01
co42001.L01
co42010.T01
co42015.T01
co72006.L01
co72013.L01
co72013.L02
co72013.T01
co72013.T02
co72013.T03
co72013.T04
co72013.T05
co72013.T06
co72016.T01
co72018.T01
coh2451.T01
coh8412555.L01
coh8412555.T02
coh8412585.T03
coh8412605.L01
coh8412605.T01
coh8412615.T03
coh8412615.T05

-- 10.How many members of staff have contact time which is greater than the average?

-- Query 1: What is the avg?

select avg(duration) as Avg
from teaches
join event on teaches.event=event.id

-- Result:
Avg
1.5261

-- Query 2: Contact time of each staff

select staff, sum(duration) over(partition by staff) as Sum
from teaches
join event on teaches.event=event.id
group by staff

-- Result:
staff	Sum
co.ACg	2
co.ACr	2
co.AFA	2
co.AL	1
co.AMn	1
co.ASc	2
co.ASr	1
co.AV	1
co.BC	2
co.CHt	2
co.CM	2
co.CMD	2
co.EH	2
co.FG	2
co.GR	2
co.GS	2
co.IS	2
co.JJ	1
co.JKg	2
co.JKy	2
co.JMy	2
co.JMz	2
co.JO	2
co.JSv	2
co.KB	1
co.KC	2
co.LM	2
co.MR	1
co.MS	2
co.PTr	2
co.RB	1
co.RK	1
co.RR	2
co.SL	2
co.SM	1
co.SRM	1
co.SS	1
co.ST	2
co.TG	2
co.TMc	2
co.TMu	2
co.TP	2
co.XL	2
co.ZZ1	2
co.ZZ7	1
co.ZZ8	1

-- Query 3 is a combination of queries 1 & 2.

select count(*)
from
(
select staff, sum(duration) over(partition by staff) as Sum
from teaches
join event on teaches.event=event.id
group by staff
) Novo
where Novo.Sum>(select avg(duration) as Avg
from teaches
join event on teaches.event=event.id
)

-- Result: WRONG according to peers.
count(*)
32

-- Query 4: Each staff member's sum of duration

select staff, sum(duration) T
from teaches
join event on teaches.event=event.id
group by staff
order by staff

-- Query 5: Each staff member's avg of duration

select avg(S)
from
(
select staff, sum(duration) S
from teaches
join event on teaches.event=event.id
group by staff
order by staff
) Novo

-- Result:
avg(S)
8.2609

-- Query 6: combo of result from the 5th query and input into the 4th query for Final RESULT!

select count(*)
from
(
select staff, sum(duration) T
from teaches
join event on teaches.event=event.id
group by staff
Having T>(select avg(S)
from
(
select staff, sum(duration) S
from teaches
join event on teaches.event=event.id
group by staff
order by staff
) Novo2
)
)Novo

-- Result:
count(*)
17

-- Neeps hard questions

-- 11.co.CHt is to be given all the teaching that co.ACg currently does. Identify those events which will clash.

-- Query approach 1: find the occupied days and time blocks for each staff and then find the clashes

-- Query 1 Part 1: staff co.ACg

select staff, b.event, a.id, date_format(a.wkstart,'%Y-%m-%d'), c.dow, c.tod, addtime(c.tod,concat(c.duration,':00')) toe
from week a
join occurs b on b.week=a.id
join event c on c.id=b.event
join teaches d on d.event=b.event
where staff='co.ACg'
order by dow, tod, toe

-- Query 1 Part 2: staff co.CHt

select staff, f.event, e.id, date_format(e.wkstart,'%Y-%m-%d'), g.dow, g.tod, addtime(g.tod,concat(g.duration,':00')) toe 
from week e
join occurs f on f.week=e.id
join event g on g.id=f.event
join teaches h on h.event=f.event
where staff='co.CHt'
order by dow, tod, toe

-- Query 1 Part 3: JOIN on same dow and same wk id

select Novo.staff, Novo2.staff, Novo.event, Novo2.event, Novo.dow, Novo2.dow, Novo.tod, Novo2.tod, Novo.toe, Novo2.toe
from
(
select staff, f.event, e.id, date_format(e.wkstart,'%Y-%m-%d'), g.dow, g.tod, addtime(g.tod,concat(g.duration,':00')) toe 
from week e
join occurs f on f.week=e.id
join event g on g.id=f.event
join teaches h on h.event=f.event
where staff='co.CHt'
order by dow, tod, toe
) Novo
join
(
select staff, b.event, a.id, date_format(a.wkstart,'%Y-%m-%d'), c.dow, c.tod, addtime(c.tod,concat(c.duration,':00')) toe
from week a
join occurs b on b.week=a.id
join event c on c.id=b.event
join teaches d on d.event=b.event
where staff='co.ACg'
order by dow, tod, toe
) Novo2
on Novo.id=Novo2.id and Novo.dow=Novo2.dow
